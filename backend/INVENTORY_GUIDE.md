# üì¶ Inventory Management System Guide

## üìö M·ª•c l·ª•c

- [T·ªïng quan](#t·ªïng-quan)
- [Ki·∫øn tr√∫c h·ªá th·ªëng](#ki·∫øn-tr√∫c-h·ªá-th·ªëng)
- [Database Schema](#database-schema)
- [Triggers & Views](#triggers--views)
- [API Service](#api-service)
- [V√≠ d·ª• s·ª≠ d·ª•ng](#v√≠-d·ª•-s·ª≠-d·ª•ng)
- [Best Practices](#best-practices)

---

## üéØ T·ªïng quan

H·ªá th·ªëng qu·∫£n l√Ω t·ªìn kho c·ªßa Medical s·ª≠ d·ª•ng ki·∫øn tr√∫c **3 b·∫£ng** ƒë·ªÉ qu·∫£n l√Ω s·∫£n ph·∫©m v√† t·ªìn kho:

```
products (Catalog)
  ‚Üì
product_variants (Pricing & SKU)
  ‚Üì
inventory (Warehouse Stock)
```

### L·ª£i √≠ch:
- ‚úÖ **Multi-warehouse support** - Qu·∫£n l√Ω t·ªìn kho nhi·ªÅu kho
- ‚úÖ **Auto-sync triggers** - T·ª± ƒë·ªông ƒë·ªìng b·ªô stock
- ‚úÖ **Stock reservation** - Gi·ªØ h√†ng khi ƒë·∫∑t ƒë∆°n
- ‚úÖ **Low stock alerts** - C·∫£nh b√°o s·∫Øp h·∫øt h√†ng
- ‚úÖ **Validation** - NgƒÉn ch·∫∑n s·ªë √¢m, reserved > quantity

---

## üèóÔ∏è Ki·∫øn tr√∫c h·ªá th·ªëng

### 1. **Products** (Catalog Layer)
**Vai tr√≤**: Th√¥ng tin m√¥ t·∫£ s·∫£n ph·∫©m

```sql
products
‚îú‚îÄ‚îÄ id, sku, name, slug
‚îú‚îÄ‚îÄ description, features, tags
‚îú‚îÄ‚îÄ category_id, brand_id, supplier_id
‚îú‚îÄ‚îÄ weight, dimensions, warranty
‚îî‚îÄ‚îÄ SEO: seo_title, seo_description, seo_keywords
```

**ƒê·∫∑c ƒëi·ªÉm**:
- ‚ùå KH√îNG c√≥ gi√°
- ‚ùå KH√îNG c√≥ s·ªë l∆∞·ª£ng t·ªìn kho
- ‚úÖ Ch·ªâ c√≥ th√¥ng tin m√¥ t·∫£

**V√≠ d·ª•**:
```
Product: "Paracetamol Tablet"
- Description: "Pain relief medication"
- Category: "Pharmaceuticals"
- Brand: "ABC Pharma"
```

---

### 2. **Product Variants** (Pricing & SKU Layer)
**Vai tr√≤**: C√°c phi√™n b·∫£n kh√°c nhau c·ªßa s·∫£n ph·∫©m

```sql
product_variants
‚îú‚îÄ‚îÄ id, product_id, sku, barcode
‚îú‚îÄ‚îÄ name, attributes (size, color, dosage...)
‚îú‚îÄ‚îÄ price, cost, compare_at_price
‚îú‚îÄ‚îÄ stock_quantity, reserved_quantity  ‚Üê T·ª± ƒë·ªông t√≠nh t·ª´ inventory
‚îú‚îÄ‚îÄ low_stock_threshold
‚îî‚îÄ‚îÄ is_default, is_active
```

**ƒê·∫∑c ƒëi·ªÉm**:
- ‚úÖ C√≥ gi√° b√°n
- ‚úÖ C√≥ `stock_quantity` (t·ªïng h·ª£p t·ª´ inventory)
- ‚úÖ M·ªói variant c√≥ SKU ri√™ng

**V√≠ d·ª•**:
```
Variant 1: "Paracetamol 500mg - H·ªôp 10 vi√™n"
‚îú‚îÄ‚îÄ SKU: MED-001-V1
‚îú‚îÄ‚îÄ Price: 15,000‚Ç´
‚îî‚îÄ‚îÄ Stock: 1,000 (t·ªïng t·ª´ t·∫•t c·∫£ kho)

Variant 2: "Paracetamol 500mg - H·ªôp 100 vi√™n"
‚îú‚îÄ‚îÄ SKU: MED-001-V2
‚îú‚îÄ‚îÄ Price: 120,000‚Ç´
‚îî‚îÄ‚îÄ Stock: 500 (t·ªïng t·ª´ t·∫•t c·∫£ kho)
```

---

### 3. **Inventory** (Warehouse Layer)
**Vai tr√≤**: T·ªìn kho th·ª±c t·∫ø t·∫°i t·ª´ng kho

```sql
inventory
‚îú‚îÄ‚îÄ id
‚îú‚îÄ‚îÄ warehouse_id        ‚Üê Kho n√†o?
‚îú‚îÄ‚îÄ variant_id          ‚Üê S·∫£n ph·∫©m n√†o?
‚îú‚îÄ‚îÄ quantity            ‚Üê S·ªë l∆∞·ª£ng c√≥ s·∫µn
‚îú‚îÄ‚îÄ reserved_quantity   ‚Üê S·ªë l∆∞·ª£ng ƒë√£ gi·ªØ
‚îî‚îÄ‚îÄ last_restocked_at
```

**C√¥ng th·ª©c**:
```
Available = quantity - reserved_quantity
Total stock = SUM(quantity) across all warehouses
```

**V√≠ d·ª•**:
```
Variant: "Paracetamol 500mg - H·ªôp 10 vi√™n"
‚îú‚îÄ‚îÄ Kho H√† N·ªôi:   quantity: 500, reserved: 50  ‚Üí available: 450
‚îú‚îÄ‚îÄ Kho TP.HCM:   quantity: 300, reserved: 20  ‚Üí available: 280
‚îú‚îÄ‚îÄ Kho ƒê√† N·∫µng:  quantity: 200, reserved: 10  ‚Üí available: 190
‚îî‚îÄ‚îÄ TOTAL:        quantity: 1000, reserved: 80 ‚Üí available: 920
```

---

## üìä Database Schema

### Warehouses (Kho)

```sql
CREATE TABLE warehouses (
  id UUID PRIMARY KEY,
  code VARCHAR(50) UNIQUE NOT NULL,      -- WH001, WH002...
  name VARCHAR(100) NOT NULL,             -- "Kho H√† N·ªôi"
  address TEXT,
  phone VARCHAR(20),
  manager_id UUID REFERENCES users(id),
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

**D·ªØ li·ªáu m·∫´u**:
```sql
INSERT INTO warehouses (code, name, address) VALUES
  ('WH001', 'Main Warehouse', 'H√† N·ªôi'),
  ('WH002', 'Kho H·ªì Ch√≠ Minh', '123 Nguy·ªÖn Hu·ªá, Q1, TP.HCM'),
  ('WH003', 'Kho ƒê√† N·∫µng', '456 Tr·∫ßn Ph√∫, H·∫£i Ch√¢u, ƒê√† N·∫µng'),
  ('WH004', 'Kho C·∫ßn Th∆°', '789 M·∫≠u Th√¢n, Ninh Ki·ªÅu, C·∫ßn Th∆°');
```

### Inventory Records

```sql
CREATE TABLE inventory (
  id UUID PRIMARY KEY,
  warehouse_id UUID REFERENCES warehouses(id) ON DELETE CASCADE,
  variant_id UUID REFERENCES product_variants(id) ON DELETE CASCADE,
  quantity INTEGER NOT NULL DEFAULT 0,
  reserved_quantity INTEGER DEFAULT 0,
  last_restocked_at TIMESTAMP,
  updated_at TIMESTAMP DEFAULT NOW(),

  UNIQUE(warehouse_id, variant_id)  -- 1 variant ch·ªâ 1 record/kho
);
```

**Constraints**:
- `quantity >= 0` (kh√¥ng cho ph√©p s·ªë √¢m)
- `reserved_quantity <= quantity` (kh√¥ng gi·ªØ qu√° s·ªë c√≥)

---

## ‚ö° Triggers & Views

### Auto-Sync Trigger

T·ª± ƒë·ªông c·∫≠p nh·∫≠t `product_variants.stock_quantity` khi `inventory` thay ƒë·ªïi:

```sql
CREATE TRIGGER trigger_sync_variant_stock_on_update
AFTER UPDATE OF quantity, reserved_quantity ON inventory
FOR EACH ROW
EXECUTE FUNCTION sync_variant_stock_from_inventory();
```

**C√°ch ho·∫°t ƒë·ªông**:
```sql
-- B∆∞·ªõc 1: Update inventory
UPDATE inventory
SET quantity = 600
WHERE variant_id = '...' AND warehouse_id = 'WH001';

-- B∆∞·ªõc 2: Trigger t·ª± ƒë·ªông ch·∫°y
-- ‚Üí T√≠nh t·ªïng quantity t·ª´ T·∫§T C·∫¢ warehouses
-- ‚Üí Update product_variants.stock_quantity = SUM(quantity)

-- K·∫øt qu·∫£: Kh√¥ng c·∫ßn code, t·ª± ƒë·ªông sync!
```

### Helper Views

#### 1. **v_product_availability** - Xem t·ªìn kho theo kho

```sql
SELECT
  product_name,
  variant_sku,
  warehouse_name,
  available_quantity,
  reserved_quantity,
  sellable_quantity,        -- quantity - reserved
  stock_status              -- 'in_stock', 'low_stock', 'out_of_stock'
FROM v_product_availability
WHERE product_name LIKE 'Paracetamol%';
```

**K·∫øt qu·∫£**:
```
product_name      | warehouse_name  | available | reserved | sellable | status
------------------|-----------------|-----------|----------|----------|------------
Paracetamol 500mg | Kho H√† N·ªôi      | 500       | 50       | 450      | in_stock
Paracetamol 500mg | Kho TP.HCM      | 300       | 20       | 280      | in_stock
Paracetamol 500mg | Kho ƒê√† N·∫µng     | 0         | 0        | 0        | out_of_stock
```

#### 2. **v_inventory_summary** - T·ªïng h·ª£p t·ªìn kho

```sql
SELECT
  product_name,
  sku,
  total_quantity,           -- SUM(quantity) all warehouses
  total_reserved,           -- SUM(reserved) all warehouses
  total_available,          -- total_quantity - total_reserved
  warehouse_count,          -- S·ªë kho c√≥ h√†ng
  stock_status
FROM v_inventory_summary
WHERE stock_status = 'low_stock';
```

**K·∫øt qu·∫£**:
```
product_name      | sku       | total_qty | reserved | available | wh_count | status
------------------|-----------|-----------|----------|-----------|----------|----------
Alcohol Swabs 70% | MED-ALC-1 | 8         | 0        | 8         | 1        | low_stock
```

---

## üîß API Service

### InventoryService Class

```typescript
import InventoryService from '@/services/inventory.service';
```

### Methods

#### 1. **getVariantInventory** - L·∫•y th√¥ng tin t·ªìn kho

```typescript
const inventory = await InventoryService.getVariantInventory(variantId);

// Returns:
{
  variant_id: "uuid",
  product_name: "Paracetamol 500mg",
  sku: "MED-001-V1",
  total_quantity: 1000,
  total_reserved: 80,
  total_available: 920,
  warehouse_count: 3,
  stock_status: "in_stock",
  locations: [
    {
      warehouse_id: "uuid",
      warehouse_code: "WH001",
      warehouse_name: "Kho H√† N·ªôi",
      quantity: 500,
      reserved_quantity: 50,
      available_quantity: 450
    },
    // ...
  ]
}
```

#### 2. **checkAvailability** - Ki·ªÉm tra ƒë·ªß h√†ng

```typescript
// Check to√†n h·ªá th·ªëng
const hasStock = await InventoryService.checkAvailability(
  variantId,
  100  // c·∫ßn 100 s·∫£n ph·∫©m
);

// Check kho c·ª• th·ªÉ
const hasStockInHN = await InventoryService.checkAvailability(
  variantId,
  100,
  'warehouse-hn-id'
);
```

#### 3. **reserveStock** - Gi·ªØ h√†ng khi ƒë·∫∑t

```typescript
// Khi kh√°ch ƒë·∫∑t h√†ng (ch∆∞a thanh to√°n)
await InventoryService.reserveStock(
  variantId,
  10,           // quantity
  warehouseId
);

// ‚Üí Inventory: reserved_quantity += 10
// ‚Üí Trigger: product_variants.reserved_quantity t·ª± ƒë·ªông tƒÉng
```

#### 4. **releaseStock** - Tr·∫£ h√†ng khi h·ªßy

```typescript
// Khi h·ªßy ƒë∆°n h√†ng
await InventoryService.releaseStock(
  variantId,
  10,           // quantity
  warehouseId
);

// ‚Üí Inventory: reserved_quantity -= 10
// ‚Üí Trigger: product_variants.reserved_quantity t·ª± ƒë·ªông gi·∫£m
```

#### 5. **deductStock** - Tr·ª´ h√†ng khi giao

```typescript
// Khi giao h√†ng th√†nh c√¥ng
await InventoryService.deductStock(
  variantId,
  10,           // quantity
  warehouseId
);

// ‚Üí Inventory: quantity -= 10, reserved_quantity -= 10
// ‚Üí Trigger: product_variants.stock_quantity t·ª± ƒë·ªông gi·∫£m
```

#### 6. **addStock** - Nh·∫≠p h√†ng

```typescript
// Nh·∫≠p h√†ng v√†o kho
await InventoryService.addStock(
  variantId,
  100,          // quantity
  warehouseId
);

// ‚Üí Inventory: quantity += 100
// ‚Üí Trigger: product_variants.stock_quantity t·ª± ƒë·ªông tƒÉng
```

#### 7. **getLowStockItems** - S·∫£n ph·∫©m s·∫Øp h·∫øt

```typescript
const lowStockItems = await InventoryService.getLowStockItems();

// Returns: Array of products with stock_status = 'low_stock' or 'out_of_stock'
```

---

## üí° V√≠ d·ª• s·ª≠ d·ª•ng

### Workflow: Kh√°ch ƒë·∫∑t h√†ng

```typescript
// 1. Ki·ªÉm tra t·ªìn kho
const hasStock = await InventoryService.checkAvailability(variantId, quantity);
if (!hasStock) {
  throw new Error('Insufficient stock');
}

// 2. T·∫°o ƒë∆°n h√†ng & gi·ªØ h√†ng
const order = await createOrder({...});
await InventoryService.reserveStock(variantId, quantity, warehouseId);

// 3a. N·∫øu thanh to√°n th√†nh c√¥ng & giao h√†ng
await InventoryService.deductStock(variantId, quantity, warehouseId);

// 3b. N·∫øu h·ªßy ƒë∆°n
await InventoryService.releaseStock(variantId, quantity, warehouseId);
```

### Workflow: Nh·∫≠p h√†ng

```typescript
// Nh·∫≠p 500 s·∫£n ph·∫©m v√†o kho TP.HCM
await InventoryService.addStock(
  variantId,
  500,
  'warehouse-hcm-id'
);

// Ki·ªÉm tra l·∫°i
const inventory = await InventoryService.getVariantInventory(variantId);
console.log(inventory.total_quantity);  // TƒÉng th√™m 500
```

### Workflow: Chuy·ªÉn kho

```typescript
// Chuy·ªÉn 100 s·∫£n ph·∫©m t·ª´ HN ‚Üí HCM
await InventoryService.deductStock(variantId, 100, 'warehouse-hn-id');
await InventoryService.addStock(variantId, 100, 'warehouse-hcm-id');

// Ho·∫∑c d√πng transfer (n·∫øu c√≥ implement)
await InventoryService.transferStock({
  fromWarehouseId: 'warehouse-hn-id',
  toWarehouseId: 'warehouse-hcm-id',
  variantId,
  quantity: 100
});
```

---

## üìã Best Practices

### 1. **Lu√¥n d√πng Inventory, kh√¥ng d√πng variant stock tr·ª±c ti·∫øp**

‚ùå **Sai**:
```typescript
// ƒê·ªçc stock t·ª´ product_variants
const variant = await getProductVariant(id);
if (variant.stock_quantity > 0) { ... }
```

‚úÖ **ƒê√∫ng**:
```typescript
// ƒê·ªçc t·ª´ inventory (c√≥ warehouse info)
const hasStock = await InventoryService.checkAvailability(variantId, quantity);
```

### 2. **Lu√¥n reserve tr∆∞·ªõc khi deduct**

‚ùå **Sai**:
```typescript
// Tr·ª´ h√†ng ngay khi ƒë·∫∑t
await InventoryService.deductStock(variantId, quantity, warehouseId);
```

‚úÖ **ƒê√∫ng**:
```typescript
// 1. Reserve khi ƒë·∫∑t h√†ng
await InventoryService.reserveStock(variantId, quantity, warehouseId);

// 2. Deduct khi giao h√†ng
await InventoryService.deductStock(variantId, quantity, warehouseId);

// 3. Release n·∫øu h·ªßy
await InventoryService.releaseStock(variantId, quantity, warehouseId);
```

### 3. **S·ª≠ d·ª•ng transaction cho multiple operations**

```typescript
const client = await pool.connect();
try {
  await client.query('BEGIN');

  // Multiple inventory operations
  await InventoryService.deductStock(variant1, 10, warehouseId);
  await InventoryService.deductStock(variant2, 5, warehouseId);

  await client.query('COMMIT');
} catch (error) {
  await client.query('ROLLBACK');
  throw error;
} finally {
  client.release();
}
```

### 4. **Monitor low stock alerts**

```typescript
// Ch·∫°y ƒë·ªãnh k·ª≥ (cronjob)
const lowStockItems = await InventoryService.getLowStockItems();

if (lowStockItems.length > 0) {
  // Send notification to managers
  await sendLowStockAlert(lowStockItems);
}
```

### 5. **Inventory reports**

```sql
-- B√°o c√°o t·ªìn kho theo kho
SELECT
  w.name as warehouse,
  COUNT(DISTINCT i.variant_id) as total_products,
  SUM(i.quantity) as total_quantity,
  SUM(i.reserved_quantity) as total_reserved,
  SUM(i.quantity - i.reserved_quantity) as total_available
FROM inventory i
JOIN warehouses w ON i.warehouse_id = w.id
GROUP BY w.id, w.name
ORDER BY w.name;

-- S·∫£n ph·∫©m b√°n ch·∫°y (reserved nhi·ªÅu nh·∫•t)
SELECT
  p.name,
  pv.sku,
  SUM(i.reserved_quantity) as total_reserved
FROM inventory i
JOIN product_variants pv ON i.variant_id = pv.id
JOIN products p ON pv.product_id = p.id
GROUP BY p.id, p.name, pv.sku
ORDER BY total_reserved DESC
LIMIT 10;
```

---

## üîÑ Migration & Seeding

### 1. T·∫°o triggers & views

```bash
psql -h localhost -U dobby -d medical -f src/migrations/create-inventory-triggers.sql
```

### 2. Sync inventory t·ª´ variants hi·ªán t·∫°i

```bash
npx ts-node src/seeders/sync-inventory.ts
```

### 3. Th√™m warehouses m·∫´u

```bash
npx ts-node src/seeders/seed-warehouses.ts
```

---

## üêõ Troubleshooting

### Issue: Stock kh√¥ng sync

**Ki·ªÉm tra trigger c√≥ ho·∫°t ƒë·ªông kh√¥ng**:
```sql
-- Test trigger
UPDATE inventory SET quantity = 999
WHERE variant_id = (SELECT id FROM product_variants LIMIT 1);

-- Check k·∫øt qu·∫£
SELECT pv.stock_quantity, i.quantity
FROM product_variants pv
JOIN inventory i ON i.variant_id = pv.id
WHERE pv.id = ...;
```

### Issue: Reserved > Quantity

**Trigger validation s·∫Ω b√°o l·ªói**:
```
ERROR: Reserved quantity (150) cannot exceed available quantity (100)
```

**Fix**: Kh√¥ng cho ph√©p reserve qu√° s·ªë l∆∞·ª£ng c√≥

### Issue: Negative quantity

**Trigger validation s·∫Ω b√°o l·ªói**:
```
ERROR: Quantity cannot be negative. Got: -10
```

**Fix**: Ki·ªÉm tra quantity tr∆∞·ªõc khi deduct

---

## üìö T√†i li·ªáu tham kh·∫£o

- [Database Triggers Documentation](./src/migrations/create-inventory-triggers.sql)
- [Inventory Service Source](./src/services/inventory.service.ts)
- [Seeder Scripts](./src/seeders/)

---

## üéâ K·∫øt lu·∫≠n

H·ªá th·ªëng inventory ƒë√£ ƒë∆∞·ª£c thi·∫øt k·∫ø ho√†n ch·ªânh v·ªõi:

‚úÖ **3-tier architecture**: Products ‚Üí Variants ‚Üí Inventory
‚úÖ **Auto-sync triggers**: T·ª± ƒë·ªông ƒë·ªìng b·ªô stock
‚úÖ **Multi-warehouse**: H·ªó tr·ª£ nhi·ªÅu kho
‚úÖ **Stock reservation**: Gi·ªØ h√†ng khi ƒë·∫∑t
‚úÖ **Validation**: NgƒÉn ch·∫∑n l·ªói logic
‚úÖ **Helper views**: Query d·ªÖ d√†ng
‚úÖ **Service layer**: API ƒë·∫ßy ƒë·ªß

**Happy Coding! üöÄ**
